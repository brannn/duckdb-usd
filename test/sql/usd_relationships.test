# name: test/sql/usd_relationships.test
# description: Test usd_relationships table function - validates relationship target expansion for graph analysis
# group: [usd]

require usd

# Use case: Extract connection topology - which sources connect to which nodes
# Useful for dependency and graph analysis
query II
SELECT prim_path, target_path
FROM usd_relationships('test/data/relationships_scene.usda')
WHERE rel_name = 'connection'
ORDER BY prim_path, target_path;
----
/World/Device_01	/World/Source_A
/World/Node_01	/World/Source_A
/World/Node_02	/World/Source_B
/World/Node_03	/World/Source_A
/World/Node_03	/World/Source_B

# Use case: Identify multi-target relationships (redundant connections)
# Find nodes with multiple connections
query III
SELECT prim_path, rel_name, COUNT(*) as target_count
FROM usd_relationships('test/data/relationships_scene.usda')
GROUP BY prim_path, rel_name
HAVING COUNT(*) > 1
ORDER BY prim_path;
----
/World/Node_03	connection	2

# Use case: Verify target_index is correct for multi-target relationships
# Ensures proper ordering of relationship targets
query IIII
SELECT prim_path, rel_name, target_path, target_index
FROM usd_relationships('test/data/relationships_scene.usda')
WHERE prim_path = '/World/Node_03'
ORDER BY target_index;
----
/World/Node_03	connection	/World/Source_A	0
/World/Node_03	connection	/World/Source_B	1

# Use case: Join relationships with prims to analyze graph structure
# Find all nodes and what they're connected to
query IIII
SELECT r.prim_path, r.rel_name, r.target_path, p.kind as target_kind
FROM usd_relationships('test/data/relationships_scene.usda') r
JOIN usd_prims('test/data/relationships_scene.usda') p
  ON r.target_path = p.prim_path
WHERE r.rel_name = 'connection'
ORDER BY r.prim_path;
----
/World/Device_01	connection	/World/Source_A	component
/World/Node_01	connection	/World/Source_A	component
/World/Node_02	connection	/World/Source_B	component
/World/Node_03	connection	/World/Source_A	component
/World/Node_03	connection	/World/Source_B	component

# Use case: Count total relationships per prim
# Useful for finding highly connected nodes in the scene graph
query II
SELECT prim_path, COUNT(*) as relationship_count
FROM usd_relationships('test/data/relationships_scene.usda')
GROUP BY prim_path
ORDER BY relationship_count DESC, prim_path;
----
/World/Device_01	2
/World/Node_03	2
/World/Node_01	1
/World/Node_02	1

# Use case: Invalid file handling
statement error
SELECT * FROM usd_relationships('test/data/nonexistent.usda');
----
USD file not found
