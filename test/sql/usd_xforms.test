# name: test/sql/usd_xforms.test
# description: Test usd_xforms table function - validates spatial transform extraction for proximity and layout analysis
# group: [usd]

require usd

# Use case: Extract object positions for spatial layout analysis
query IIII
SELECT prim_path, x, y, z
FROM usd_xforms('test/data/transforms_scene.usda')
WHERE prim_path LIKE '/World/Object_%'
ORDER BY x, z;
----
/World/Object_A	10.0	0.0	0.0
/World/Object_B	10.0	0.0	5.0
/World/Object_C	20.0	0.0	5.0

# Use case: Verify nested transform inheritance
# Ensures child prims correctly inherit parent transforms
query IIII
SELECT prim_path, x, y, z
FROM usd_xforms('test/data/transforms_scene.usda')
WHERE prim_path LIKE '%/Group_A%'
ORDER BY prim_path;
----
/World/Group_A	100.0	0.0	0.0
/World/Group_A/Child_01	100.0	0.0	5.0
/World/Group_A/Child_02	100.0	0.0	10.0

# Use case: Detect scaled objects
# Important for identifying objects with non-standard dimensions
query III
SELECT prim_path, has_scale, has_rotation
FROM usd_xforms('test/data/transforms_scene.usda')
WHERE has_scale = true OR has_rotation = true
ORDER BY prim_path;
----
/World/ScaledObject	true	false

# Use case: Proximity analysis - find nearest anchor to each object
query III
WITH object_positions AS (
    SELECT prim_path, x, y, z
    FROM usd_xforms('test/data/transforms_scene.usda')
    WHERE prim_path LIKE '/World/Object_%'
),
anchor_positions AS (
    SELECT prim_path, x, y, z
    FROM usd_xforms('test/data/transforms_scene.usda')
    WHERE prim_path LIKE '%/Anchor%'
)
SELECT
    o.prim_path as object,
    a.prim_path as nearest_anchor,
    ROUND(SQRT(POW(o.x - a.x, 2) + POW(o.y - a.y, 2) + POW(o.z - a.z, 2)), 2) as distance
FROM object_positions o
CROSS JOIN anchor_positions a
QUALIFY ROW_NUMBER() OVER (PARTITION BY o.prim_path ORDER BY distance) = 1
ORDER BY distance;
----
/World/Object_A	/World/Anchor_01	5.0
/World/Object_B	/World/Anchor_01	7.07
/World/Object_C	/World/Anchor_01	7.07

# Use case: Spatial filtering - find objects within a bounding box
query I
SELECT prim_path
FROM usd_xforms('test/data/transforms_scene.usda')
WHERE x BETWEEN 5 AND 25
  AND z BETWEEN 0 AND 10
ORDER BY prim_path;
----
/World/Anchor_01
/World/Object_A
/World/Object_B
/World/Object_C
/World/RotatedObject

# Use case: Count objects by vertical level (Y coordinate)
query II
SELECT
    CASE
        WHEN y = 0 THEN 'Ground Floor'
        WHEN y > 0 AND y < 5 THEN 'Mezzanine'
        ELSE 'Upper Level'
    END as level,
    COUNT(*) as object_count
FROM usd_xforms('test/data/transforms_scene.usda')
WHERE prim_path LIKE '%/Object_%' OR prim_path LIKE '%/Anchor%' OR prim_path LIKE '%Object'
GROUP BY level
ORDER BY level;
----
Ground Floor	4
Mezzanine	1
Upper Level	1

# Use case: Invalid file handling
statement error
SELECT * FROM usd_xforms('test/data/nonexistent.usda');
----
USD file not found
