# name: test/sql/usd_xforms.test
# description: Test usd_xforms table function - validates spatial transform extraction for proximity and layout analysis
# group: [usd]

require usd

# Use case: Extract equipment positions for spatial layout analysis
# Critical for datacenter floor planning and equipment placement
query IIII
SELECT prim_path, x, y, z
FROM usd_xforms('test/data/transforms_scene.usda')
WHERE prim_path LIKE '%/Rack_%' AND prim_path NOT LIKE '%/%/%'
ORDER BY x, z;
----
/World/Rack_A	10.0	0.0	0.0
/World/Rack_B	10.0	0.0	5.0
/World/Rack_C	20.0	0.0	5.0

# Use case: Verify nested transform inheritance
# Ensures child prims correctly inherit parent transforms
query IIII
SELECT prim_path, x, y, z
FROM usd_xforms('test/data/transforms_scene.usda')
WHERE prim_path LIKE '%/DatacenterRow%'
ORDER BY prim_path;
----
/World/DatacenterRow	100.0	0.0	0.0
/World/DatacenterRow/Rack_D	100.0	0.0	5.0
/World/DatacenterRow/Rack_E	100.0	0.0	10.0

# Use case: Detect scaled equipment
# Important for identifying equipment with non-standard dimensions
query III
SELECT prim_path, has_scale, has_rotation
FROM usd_xforms('test/data/transforms_scene.usda')
WHERE has_scale = true OR has_rotation = true
ORDER BY prim_path;
----
/World/ScaledEquipment	true	false

# Use case: Proximity analysis - find nearest cooling unit to each rack
# Critical for thermal management and cooling efficiency
query III
WITH rack_positions AS (
    SELECT prim_path, x, y, z
    FROM usd_xforms('test/data/transforms_scene.usda')
    WHERE prim_path LIKE '%/Rack_%' AND prim_path NOT LIKE '%/%/%'
),
crac_positions AS (
    SELECT prim_path, x, y, z
    FROM usd_xforms('test/data/transforms_scene.usda')
    WHERE prim_path LIKE '%/CRAC%'
)
SELECT
    r.prim_path as rack,
    c.prim_path as nearest_crac,
    ROUND(SQRT(POW(r.x - c.x, 2) + POW(r.y - c.y, 2) + POW(r.z - c.z, 2)), 2) as distance
FROM rack_positions r
CROSS JOIN crac_positions c
QUALIFY ROW_NUMBER() OVER (PARTITION BY r.prim_path ORDER BY distance) = 1
ORDER BY distance;
----
/World/Rack_A	/World/CRAC_01	5.0
/World/Rack_B	/World/CRAC_01	7.07
/World/Rack_C	/World/CRAC_01	7.07

# Use case: Spatial filtering - find equipment within a bounding box
# Useful for analyzing specific datacenter zones
query I
SELECT prim_path
FROM usd_xforms('test/data/transforms_scene.usda')
WHERE x BETWEEN 5 AND 25
  AND z BETWEEN 0 AND 10
ORDER BY prim_path;
----
/World/CRAC_01
/World/Rack_A
/World/Rack_B
/World/Rack_C
/World/RotatedEquipment

# Use case: Count equipment by floor level (Y coordinate)
# Helps analyze vertical distribution in multi-level datacenters
query II
SELECT 
    CASE 
        WHEN y = 0 THEN 'Ground Floor'
        WHEN y > 0 AND y < 5 THEN 'Mezzanine'
        ELSE 'Upper Level'
    END as level,
    COUNT(*) as equipment_count
FROM usd_xforms('test/data/transforms_scene.usda')
WHERE prim_path LIKE '%/Rack_%' OR prim_path LIKE '%/CRAC%' OR prim_path LIKE '%Equipment'
GROUP BY level
ORDER BY level;
----
Ground Floor	4
Mezzanine	1
Upper Level	1

# Use case: Invalid file handling
statement error
SELECT * FROM usd_xforms('test/data/nonexistent.usda');

